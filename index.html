<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Mystic Frontier Calculator - Auto UI Detection</title>
<style>
  body { margin:0; font-family:sans-serif; background:#121212; color:#fff; }
  #container { display:flex; height:100vh; }
  #leftPanel { flex:2; display:flex; justify-content:center; align-items:center; background:#1e1e1e; }
  #canvas { border:2px solid #444; }
  #rightPanel { flex:1; padding:20px; display:flex; flex-direction:column; background:#1c1c1c; overflow:auto; }
  h2 { margin-top:0; }
  .section { margin-top:15px; border-top:1px solid #333; padding-top:10px; }
  .dice-box { display:flex; gap:10px; margin-top:5px; }
  .dice { width:40px; height:40px; background:#333; border-radius:5px; display:flex; justify-content:center; align-items:center; font-weight:bold; font-size:18px; }
  textarea { width:100%; background:#222; color:#0f0; border:none; padding:5px; font-family:monospace; }
  select { padding:5px; background:#222; color:#fff; border:none; margin-left:5px; }
  button { padding:8px 12px; margin-top:5px; background:#0066ff; border:none; color:#fff; border-radius:4px; cursor:pointer; }
  button:hover { background:#0055cc; }
  .summary { font-size:24px; margin-bottom:10px; }
  .reroll-suggestion { color:#ff0; margin-top:5px; }
</style>
<script src="https://cdn.jsdelivr.net/npm/tesseract.js@4.1.1/dist/tesseract.min.js"></script>
</head>
<body>

<div id="container">
  <!-- Left Panel: Screen Capture -->
  <div id="leftPanel">
    <canvas id="canvas" width="700" height="400"></canvas>
  </div>

  <!-- Right Panel: Analysis -->
  <div id="rightPanel">
    <h2>Analysis Results</h2>
    <div class="summary" id="summary">TOTAL + DICE x MULTIPLIER</div>
    <div>DICE</div>
    <div class="dice-box" id="diceDisplay">
      <div class="dice" id="D1">?</div>
      <div class="dice" id="D2">?</div>
      <div class="dice" id="D3">?</div>
    </div>

    <div class="section">
      <strong>Familiar Rarity:</strong>
      <select id="fam1"><option value="3">Common</option><option value="4">Rare</option><option value="5">Epic</option><option value="6">Unique+</option></select>
      <select id="fam2"><option value="3">Common</option><option value="4">Rare</option><option value="5">Epic</option><option value="6">Unique+</option></select>
      <select id="fam3"><option value="3">Common</option><option value="4">Rare</option><option value="5">Epic</option><option value="6">Unique+</option></select>
    </div>

    <div class="section">
      <strong>SITE DETAILS</strong>
      <div>White Dice: Multiplier +1.2</div>
      <div>Blue Dice: -1 to Dice, Multiplier +1.4</div>
      <div>Purple Dice: +1 to Dice, Multiplier +1.6</div>
      <div>Orange Dice: +1 to Dice, Multiplier +2</div>
    </div>

    <div class="section">
      <strong>ATTRIBUTES</strong>
      <div id="attributesDisplay"></div>
    </div>

    <div class="section">
      <strong>Raw OCR Text</strong>
      <textarea id="rawText" rows="6" readonly>No text detected</textarea>
    </div>

    <div class="section">
      <button id="selectScreen">Select Screen</button>
      <button id="process">Process OCR</button>
      <div class="reroll-suggestion" id="reroll"></div>
    </div>
  </div>
</div>

<script>
let canvas = document.getElementById('canvas');
let ctx = canvas.getContext('2d');
let videoStream;

const bonusDice = {
  "white": {dice:0, mult:1.2},
  "blue": {dice:-1, mult:1.4},
  "purple": {dice:1, mult:1.6},
  "orange": {dice:1, mult:2.0}
};

let dice = [0,0,0];
let rerollsLeft = 3;

async function detectGameUI(imageData) {
  // Simple placeholder: assume the entire canvas is the UI for now
  // Future: implement border/color detection to crop cat-border automatically
  return {x:0, y:0, width:canvas.width, height:canvas.height};
}

async function runOCR(cropped) {
  const {data:{text}} = await Tesseract.recognize(cropped, 'eng', {logger:m=>console.log(m)});
  return text;
}

document.getElementById('selectScreen').onclick = async ()=>{
  try{
    videoStream = await navigator.mediaDevices.getDisplayMedia({video:true});
    let video = document.createElement('video');
    video.srcObject = videoStream;
    await video.play();
    ctx.drawImage(video,0,0,canvas.width,canvas.height);
    video.pause();
    video.srcObject.getTracks()[0].stop();
  }catch(e){alert("Screen capture failed: "+e);}
};

document.getElementById('process').onclick = async ()=>{
  // Detect UI region (cat-border)
  let uiBox = await detectGameUI(ctx.getImageData(0,0,canvas.width,canvas.height));
  let croppedCanvas = document.createElement('canvas');
  croppedCanvas.width = uiBox.width;
  croppedCanvas.height = uiBox.height;
  let croppedCtx = croppedCanvas.getContext('2d');
  croppedCtx.putImageData(ctx.getImageData(uiBox.x, uiBox.y, uiBox.width, uiBox.height),0,0);

  // OCR the UI
  let rawText = await runOCR(croppedCanvas);
  document.getElementById('rawText').value = rawText;

  // Extract dice, target, attributes from raw text (simple regex parsing demo)
  // Number to beat
  let targetMatch = rawText.match(/number to beat[:\s]*([0-9]+)/i);
  let target = targetMatch ? parseInt(targetMatch[1]) : 25;

  // Dice values (placeholder regex)
  let diceMatches = rawText.match(/dice\s*1[:\s]*([0-9]+)/i);
  dice[0] = diceMatches?parseInt(diceMatches[1]):Math.ceil(Math.random()*3);
  diceMatches = rawText.match(/dice\s*2[:\s]*([0-9]+)/i);
  dice[1] = diceMatches?parseInt(diceMatches[1]):Math.ceil(Math.random()*3);
  diceMatches = rawText.match(/dice\s*3[:\s]*([0-9]+)/i);
  dice[2] = diceMatches?parseInt(diceMatches[1]):Math.ceil(Math.random()*3);

  // Attributes parsing (lines that mention die or familiar)
  let lines = rawText.split("\n").filter(l=>l.trim()!="");
  let totalDice = dice.reduce((a,b)=>a+b,0);
  let multiplier = 1.0;
  let appliedAttrs = [];
  for(let line of lines){
    let l = line.toLowerCase();
    // Dice-dependent
    if(l.includes("second die") && l.includes("even") && dice[1]%2===0){ totalDice += 6; appliedAttrs.push(line); }
    if(l.includes("third die") && l.includes("odd") && dice[2]%2===1){ totalDice += 6; appliedAttrs.push(line); }
    // Familiar-dependent always true
    if(l.includes("poison elemental") || l.includes("all familiars different")) {
      if(l.includes("dice total")) totalDice += parseInt(l.match(/(\d+)/)[0]);
      if(l.includes("multiplier")) multiplier *= parseFloat(l.match(/(\d+(\.\d+)?)/)[0]);
      appliedAttrs.push(line);
    }
  }

  // Assume all bonus dice are white for demo
  multiplier *= bonusDice["white"].mult;
  totalDice += bonusDice["white"].dice;

  // Update UI
  document.getElementById('D1').innerText = dice[0];
  document.getElementById('D2').innerText = dice[1];
  document.getElementById('D3').innerText = dice[2];
  document.getElementById('attributesDisplay').innerHTML = appliedAttrs.map(t=>"<div>"+t+"</div>").join("");
  let finalScore = Math.floor(totalDice * multiplier);
  document.getElementById('summary').innerText = `${totalDice} + ${dice.reduce((a,b)=>a+b,0)} x ${multiplier.toFixed(1)} = ${finalScore}`;

  // Reroll suggestion
  if(finalScore<target && rerollsLeft>0){
    rerollsLeft--;
    let fam = [parseInt(document.getElementById('fam1').value),
               parseInt(document.getElementById('fam2').value),
               parseInt(document.getElementById('fam3').value)];
    let worstDie = dice.indexOf(Math.min(...dice));
    document.getElementById('reroll').innerText = `Reroll die ${worstDie+1} for best chance (rerolls left: ${rerollsLeft})`;
  } else {
    document.getElementById('reroll').innerText = '';
  }
};
</script>

</body>
</html>
