<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Mystic Frontier Calculator - Dynamic Attributes</title>
<style>
  body { margin: 0; font-family: sans-serif; background:#121212; color:#fff; }
  #container { display:flex; height:100vh; }
  #leftPanel { flex:2; display:flex; justify-content:center; align-items:center; background:#1e1e1e; }
  #canvas { border:2px solid #444; }
  #rightPanel { flex:1; padding:20px; display:flex; flex-direction:column; background:#1c1c1c; overflow:auto; }
  h2 { margin-top:0; }
  .section { margin-top:15px; border-top:1px solid #333; padding-top:10px; }
  .dice-box { display:flex; gap:10px; margin-top:5px; }
  .dice { width:40px; height:40px; background:#333; border-radius:5px; display:flex; justify-content:center; align-items:center; font-weight:bold; font-size:18px; }
  .bonus { color:#0f0; margin-left:5px; }
  textarea { width:100%; background:#222; color:#0f0; border:none; padding:5px; font-family:monospace; }
  select { padding:5px; background:#222; color:#fff; border:none; margin-left:5px; }
  button { padding:8px 12px; margin-top:5px; background:#0066ff; border:none; color:#fff; border-radius:4px; cursor:pointer; }
  button:hover { background:#0055cc; }
  .summary { font-size:24px; margin-bottom:10px; }
  .reroll-suggestion { color:#ff0; margin-top:5px; }
</style>
<script src="https://cdn.jsdelivr.net/npm/tesseract.js@4.1.1/dist/tesseract.min.js"></script>
</head>
<body>

<div id="container">
  <!-- Left Panel: Screen Capture -->
  <div id="leftPanel">
    <canvas id="canvas" width="700" height="400"></canvas>
  </div>

  <!-- Right Panel: Analysis -->
  <div id="rightPanel">
    <h2>Analysis Results</h2>

    <!-- Top Summary -->
    <div class="summary" id="summary">TOTAL + DICE x MULTIPLIER</div>

    <!-- Dice Display -->
    <div>DICE</div>
    <div class="dice-box" id="diceDisplay">
      <div class="dice" id="D1">?</div>
      <div class="dice" id="D2">?</div>
      <div class="dice" id="D3">?</div>
    </div>

    <!-- Familiar Rarity Selection -->
    <div class="section">
      <strong>Familiar Rarity:</strong>
      <select id="fam1"><option value="3">Common</option><option value="4">Rare</option><option value="5">Epic</option><option value="6">Unique+</option></select>
      <select id="fam2"><option value="3">Common</option><option value="4">Rare</option><option value="5">Epic</option><option value="6">Unique+</option></select>
      <select id="fam3"><option value="3">Common</option><option value="4">Rare</option><option value="5">Epic</option><option value="6">Unique+</option></select>
    </div>

    <!-- Site Details -->
    <div class="section">
      <strong>SITE DETAILS</strong>
      <div>White Dice: Multiplier +1.2</div>
      <div>Blue Dice: -1 to Dice, Multiplier +1.4</div>
      <div>Purple Dice: +1 to Dice, Multiplier +1.6</div>
      <div>Orange Dice: +1 to Dice, Multiplier +2</div>
    </div>

    <!-- Attributes -->
    <div class="section">
      <strong>ATTRIBUTES</strong>
      <div id="attributesDisplay"></div>
    </div>

    <!-- Raw OCR Text -->
    <div class="section">
      <strong>Raw Text</strong>
      <textarea id="rawText" rows="6" readonly>No text detected</textarea>
    </div>

    <!-- Controls -->
    <div class="section">
      <button id="selectScreen">Select Screen</button>
      <button id="process">Process OCR</button>
      <div class="reroll-suggestion" id="reroll"></div>
    </div>
  </div>
</div>

<script>
let canvas = document.getElementById('canvas');
let ctx = canvas.getContext('2d');
let videoStream;

const bonusDice = {
  "white": {dice:0, mult:1.2},
  "blue": {dice:-1, mult:1.4},
  "purple": {dice:1, mult:1.6},
  "orange": {dice:1, mult:2.0}
};

let dice = [0,0,0];
let rerollsLeft = 3;

document.getElementById('selectScreen').onclick = async ()=>{
  try{
    videoStream = await navigator.mediaDevices.getDisplayMedia({video:true});
    let video = document.createElement('video');
    video.srcObject = videoStream;
    video.play();
    video.onloadedmetadata = ()=>{
      ctx.drawImage(video,0,0,canvas.width,canvas.height);
      video.pause();
      video.srcObject.getTracks()[0].stop();
    };
  }catch(e){alert("Screen capture failed: "+e);}
};

document.getElementById('process').onclick = async ()=>{
  // Get familiar rarities
  let fam = [parseInt(document.getElementById('fam1').value),
             parseInt(document.getElementById('fam2').value),
             parseInt(document.getElementById('fam3').value)];

  // Generate dice randomly for now; later replace with OCR
  dice = [Math.ceil(Math.random()*fam[0]),
          Math.ceil(Math.random()*fam[1]),
          Math.ceil(Math.random()*fam[2])];

  // Placeholder: raw OCR attribute text
  let rawAttrText = "If second die even, Dice Total +6\nPoison elemental active, Multiplier +1.6\nAll familiars different element, Dice Total +3";
  document.getElementById('rawText').value = rawAttrText;

  // Parse attributes
  let lines = rawAttrText.split("\n");
  let totalDice = dice.reduce((a,b)=>a+b,0);
  let multiplier = 1.0;
  let appliedAttrs = [];

  for(let line of lines){
    line = line.toLowerCase();
    // Dice-dependent
    if(line.includes("second die") && line.includes("even") && dice[1]%2===0){
      totalDice += 6; appliedAttrs.push(line);
    }
    if(line.includes("third die") && line.includes("odd") && dice[2]%2===1){
      totalDice += 6; appliedAttrs.push(line);
    }
    // Familiar-dependent (always apply)
    if(line.includes("poison elemental") || line.includes("all familiars different")){
      if(line.includes("dice total")) totalDice += parseInt(line.match(/(\d+)/)[0]);
      if(line.includes("multiplier")) multiplier *= parseFloat(line.match(/(\d+(\.\d+)?)/)[0]);
      appliedAttrs.push(line);
    }
  }

  // Apply demo bonus dice (assume all white)
  multiplier *= bonusDice["white"].mult;
  totalDice += bonusDice["white"].dice;

  // Update dice UI
  document.getElementById('D1').innerText = dice[0];
  document.getElementById('D2').innerText = dice[1];
  document.getElementById('D3').innerText = dice[2];

  // Update attributes UI
  document.getElementById('attributesDisplay').innerHTML = appliedAttrs.map(t=>"<div>"+t+"</div>").join("");

  // Calculate final score
  let finalScore = Math.floor(totalDice * multiplier);
  document.getElementById('summary').innerText = `${totalDice} + ${dice.reduce((a,b)=>a+b,0)} x ${multiplier.toFixed(1)} = ${finalScore}`;

  // Reroll suggestion
  let target = 25; // demo target
  if(finalScore<target && rerollsLeft>0){
    rerollsLeft--;
    let maxVals = [fam[0],fam[1],fam[2]];
    let worstDie = dice.indexOf(Math.min(...dice));
    document.getElementById('reroll').innerText = `Reroll die ${worstDie+1} for best chance (rerolls left: ${rerollsLeft})`;
  } else {
    document.getElementById('reroll').innerText = '';
  }
};
</script>

</body>
</html>
