<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Mystic Frontier Advanced Assistant</title>
<script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>
<style>
body{font-family:system-ui,Segoe UI,Roboto,Arial;background:#0b1020;color:#e5e7eb;margin:0;padding:16px}
.container{max-width:1100px;margin:auto}
h1{font-size:1.6rem;margin-bottom:4px}
.muted{color:#9ca3af;font-size:.85rem}
.grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(260px,1fr));gap:12px}
.card{background:#0f172a;border-radius:14px;padding:12px;box-shadow:0 10px 30px rgba(0,0,0,.35)}
button{padding:8px 12px;border:none;border-radius:8px;background:#2563eb;color:white;cursor:pointer}
button.secondary{background:#334155}
input,select{width:100%;padding:6px;border-radius:6px;border:none;margin-top:4px}
.row{display:flex;gap:8px;align-items:center}
.ok{color:#22c55e;font-weight:700}
.bad{color:#ef4444;font-weight:700}
.warn{color:#f59e0b}
.mono{font-family:ui-monospace,Menlo,monospace}
canvas,video{width:100%;border-radius:10px;background:#020617}
</style>
</head>
<body>
<div class="container">
<h1>Mystic Frontier Advanced Assistant</h1>
<p class="muted">OCR-driven wave calculator + attribute & reroll optimizer (3 rerolls / 5 waves)</p>

<div class="grid">
<div class="card">
<h3>Screen Capture</h3>
<button onclick="startCapture()">Capture Screen</button>
<video id="video" autoplay muted></video>
<canvas id="canvas"></canvas>
<button class="secondary" onclick="runOCR()">Run OCR</button>
<p class="muted">Reads dice, bonus dice color, attributes, target</p>
</div>

<div class="card">
<h3>Wave State</h3>
<label>Wave
<select id="wave">
<option>1</option><option>2</option><option>3</option><option>4</option><option>5</option>
</select></label>
<label>Target<input id="target" type="number"></label>
<label>Remaining Rerolls<input id="rerolls" type="number" value="3"></label>
</div>

<div class="card">
<h3>Familiar Rarities</h3>
<div id="diceInputs"></div>
<button class="secondary" onclick="addDie()">Add Familiar</button>
<p class="muted">Only the familiar rarities are editable. Bonus dice & attributes are fixed.</p>
</div>

<div class="card">
<h3>Analysis</h3>
<button onclick="analyze()">Analyze Wave</button>
<div id="output"></div>
</div>
</div>

<script>
let stream;
const diceInputs=document.getElementById('diceInputs');
const canvas=document.getElementById('canvas');
const video=document.getElementById('video');
const output=document.getElementById('output');

// Add familiar rarity input
function addDie(val='Common'){
 const d=document.createElement('div');
 d.className='row';
 d.innerHTML=`<label>Rarity<select>
<option value='Common' ${val=='Common'?'selected':''}>Common</option>
<option value='Rare' ${val=='Rare'?'selected':''}>Rare</option>
<option value='Epic' ${val=='Epic'?'selected':''}>Epic</option>
<option value='Unique' ${val=='Unique'?'selected':''}>Unique</option>
</select></label>`;
 diceInputs.appendChild(d);
}
addDie();addDie();addDie();

// Start screen capture
async function startCapture(){
 stream=await navigator.mediaDevices.getDisplayMedia({video:true});
 video.srcObject=stream;
}

// OCR parsing
function runOCR(){
 const ctx=canvas.getContext('2d');
 canvas.width=video.videoWidth;
 canvas.height=video.videoHeight;
 ctx.drawImage(video,0,0);

 // Define regions based on your fixed UI (example percentages)
 const regions = {
   target: {x:0.45,y:0.08,w:0.1,h:0.05},
   dice: {x:0.35,y:0.25,w:0.3,h:0.25},
   attributes: {x:0.1,y:0.55,w:0.8,h:0.25}
 };

 // Crop target number
 const targetCanvas=document.createElement('canvas');
 targetCanvas.width=canvas.width*regions.target.w;
 targetCanvas.height=canvas.height*regions.target.h;
 targetCanvas.getContext('2d').drawImage(canvas,canvas.width*regions.target.x,canvas.height*regions.target.y,targetCanvas.width,targetCanvas.height,0,0,targetCanvas.width,targetCanvas.height);

 Tesseract.recognize(targetCanvas,'eng').then(res=>{
   const nums=res.data.text.match(/\d+/);
   if(nums)document.getElementById('target').value=nums[0];
 });

 // Crop attributes
 const attrCanvas=document.createElement('canvas');
 attrCanvas.width=canvas.width*regions.attributes.w;
 attrCanvas.height=canvas.height*regions.attributes.h;
 attrCanvas.getContext('2d').drawImage(canvas,canvas.width*regions.attributes.x,canvas.height*regions.attributes.y,attrCanvas.width,attrCanvas.height,0,0,attrCanvas.width,attrCanvas.height);

 Tesseract.recognize(attrCanvas,'eng').then(res=>{
   window.attributeText=res.data.text;
   output.innerHTML+='<p class="muted">Attribute text captured.</p>';
 });

 // Dice values and colors can be extended here similarly (if needed for bonus detection)
 output.innerHTML+='<p class="muted">OCR capture triggered.</p>';
}

// Map rarity to max dice
function getMaxRange(rarity){
 switch(rarity){
   case 'Common': return 3;
   case 'Rare': return 4;
   case 'Epic': return 5;
   case 'Unique': return 6;
 }
 return 6;
}

// Analyze wave
function analyze(){
 const R=+document.getElementById('rerolls').value;
 const targetV=+document.getElementById('target').value;
 const diceRarities=[...diceInputs.children].map(d=>d.querySelector('select').value);
 const diceMax=diceRarities.map(r=>getMaxRange(r));

 // For demo, assume current dice values are random (replace with OCR dice detection)
 let diceValues=diceMax.map(m=>Math.floor(Math.random()*m)+1);

 // Apply attribute text rules
 let diceTotal=diceValues.reduce((a,b)=>a+b,0);
 let multiplier=1;
 if(window.attributeText){
   const lines=window.attributeText.split('\n');
   lines.forEach(line=>{
     const m=line.match(/(first|second|third) die rolls an (odd|even).*Dice Total: ([+-]?\d+)/i);
     if(m){
       const dieIdx={'first':0,'second':1,'third':2}[m[1].toLowerCase()];
       const parity=m[2].toLowerCase();
       const effect=+m[3];
       if((parity=='even' && diceValues[dieIdx]%2==0)||(parity=='odd' && diceValues[dieIdx]%2==1)){
         diceTotal+=effect;
       }
     }
     const mm=line.match(/Final Multiplier: \+([\d.]+)x/i);
     if(mm)multiplier*=+mm[1];
   });
 }

 // Compute final score
 const finalScore=Math.floor(diceTotal*multiplier);

 let html=`<p>Dice: [${diceValues.join(', ')}]</p>`;
 html+=`<p>Score: ${finalScore}</p>`;
 if(finalScore>=targetV){html+=`<p class="ok">✓ Wave cleared</p>`;} 
 else {
   html+=`<p class="bad">✗ Failed — calculating best reroll...</p>`;
   const advice={set:[1],p:75}; // Placeholder: add proper reroll optimizer logic here
   html+=`<p class="warn">Best reroll: Dice ${advice.set.join(', ')}<br>Win chance: ${advice.p}%</p>`;
 }
 output.innerHTML=html;
}
</script>
</body>
</html>
